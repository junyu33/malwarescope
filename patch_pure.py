import pefile, sys

def patch_pe_file(name, addr, new_code, output):
    # 加载PE文件
    pe = pefile.PE(name)
    va_function = addr

    ra_function = pe.get_offset_from_rva(va_function - pe.OPTIONAL_HEADER.ImageBase)

    # 进行patch
    pe.set_bytes_at_offset(ra_function, new_code)

    # 写入修改后的PE文件
    pe.write(output)



if __name__ == '__main__':
    if len(sys.argv) != 3:
        print('Usage: python patch.py <pefile> <addr>')
        sys.exit(1)

    name = sys.argv[1]
    patch_pe_file(name, int(sys.argv[2], 16), b'\xeb\xfe', name + '.patched')
